{"version":3,"sources":["../src/embedder.ts"],"sourcesContent":["/**\n * Copyright 2024 Google LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Genkit, z } from 'genkit';\nimport { EmbedderReference, embedderRef } from 'genkit/embedder';\nimport { GoogleAuth } from 'google-auth-library';\nimport { PluginOptions } from './common/types.js';\nimport { PredictClient, predictModel } from './predict.js';\n\nexport const TaskTypeSchema = z.enum([\n  'RETRIEVAL_DOCUMENT',\n  'RETRIEVAL_QUERY',\n  'SEMANTIC_SIMILARITY',\n  'CLASSIFICATION',\n  'CLUSTERING',\n]);\n\nexport type TaskType = z.infer<typeof TaskTypeSchema>;\n\nexport const VertexEmbeddingConfigSchema = z.object({\n  /**\n   * The `task_type` parameter is defined as the intended downstream application to help the model\n   * produce better quality embeddings.\n   **/\n  taskType: TaskTypeSchema.optional(),\n  title: z.string().optional(),\n  location: z.string().optional(),\n  version: z.string().optional(),\n});\n\nexport type VertexEmbeddingConfig = z.infer<typeof VertexEmbeddingConfigSchema>;\n\nfunction commonRef(\n  name: string,\n  input?: ('text' | 'image')[]\n): EmbedderReference<typeof VertexEmbeddingConfigSchema> {\n  return embedderRef({\n    name: `vertexai/${name}`,\n    configSchema: VertexEmbeddingConfigSchema,\n    info: {\n      dimensions: 768,\n      label: `Vertex AI - ${name}`,\n      supports: {\n        input: input ?? ['text'],\n      },\n    },\n  });\n}\n\nexport const textEmbeddingGecko003 = commonRef('textembedding-gecko@003');\nexport const textEmbedding004 = commonRef('text-embedding-004');\nexport const textEmbeddingGeckoMultilingual001 = commonRef(\n  'textembedding-gecko-multilingual@001'\n);\nexport const textMultilingualEmbedding002 = commonRef(\n  'text-multilingual-embedding-002'\n);\n\nexport const SUPPORTED_EMBEDDER_MODELS: Record<string, EmbedderReference> = {\n  'textembedding-gecko@003': textEmbeddingGecko003,\n  'text-embedding-004': textEmbedding004,\n  'textembedding-gecko-multilingual@001': textEmbeddingGeckoMultilingual001,\n  'text-multilingual-embedding-002': textMultilingualEmbedding002,\n  // TODO: add support for multimodal embeddings\n  // 'multimodalembedding@001': commonRef('multimodalembedding@001', [\n  //   'image',\n  //   'text',\n  // ]),\n};\n\ninterface EmbeddingInstance {\n  task_type?: TaskType;\n  content: string;\n  title?: string;\n}\ninterface EmbeddingPrediction {\n  embeddings: {\n    statistics: {\n      truncated: boolean;\n      token_count: number;\n    };\n    values: number[];\n  };\n}\n\nexport function defineVertexAIEmbedder(\n  ai: Genkit,\n  name: string,\n  client: GoogleAuth,\n  options: PluginOptions\n) {\n  const embedder = SUPPORTED_EMBEDDER_MODELS[name];\n  const predictClients: Record<\n    string,\n    PredictClient<EmbeddingInstance, EmbeddingPrediction>\n  > = {};\n  const predictClientFactory = (\n    config: VertexEmbeddingConfig\n  ): PredictClient<EmbeddingInstance, EmbeddingPrediction> => {\n    const requestLocation = config?.location || options.location;\n    if (!predictClients[requestLocation]) {\n      // TODO: Figure out how to allow different versions while still sharing a single implementation.\n      predictClients[requestLocation] = predictModel<\n        EmbeddingInstance,\n        EmbeddingPrediction\n      >(\n        client,\n        {\n          ...options,\n          location: requestLocation,\n        },\n        name\n      );\n    }\n    return predictClients[requestLocation];\n  };\n\n  return ai.defineEmbedder(\n    {\n      name: embedder.name,\n      configSchema: embedder.configSchema,\n      info: embedder.info!,\n    },\n    async (input, options) => {\n      const predictClient = predictClientFactory(options);\n      const response = await predictClient(\n        input.map((i) => {\n          return {\n            content: i.text,\n            task_type: options?.taskType,\n            title: options?.title,\n          };\n        })\n      );\n      return {\n        embeddings: response.predictions.map((p) => ({\n          embedding: p.embeddings.values,\n        })),\n      };\n    }\n  );\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAgBA,oBAA0B;AAC1B,sBAA+C;AAG/C,qBAA4C;AAErC,MAAM,iBAAiB,gBAAE,KAAK;AAAA,EACnC;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF,CAAC;AAIM,MAAM,8BAA8B,gBAAE,OAAO;AAAA;AAAA;AAAA;AAAA;AAAA,EAKlD,UAAU,eAAe,SAAS;AAAA,EAClC,OAAO,gBAAE,OAAO,EAAE,SAAS;AAAA,EAC3B,UAAU,gBAAE,OAAO,EAAE,SAAS;AAAA,EAC9B,SAAS,gBAAE,OAAO,EAAE,SAAS;AAC/B,CAAC;AAID,SAAS,UACP,MACA,OACuD;AACvD,aAAO,6BAAY;AAAA,IACjB,MAAM,YAAY,IAAI;AAAA,IACtB,cAAc;AAAA,IACd,MAAM;AAAA,MACJ,YAAY;AAAA,MACZ,OAAO,eAAe,IAAI;AAAA,MAC1B,UAAU;AAAA,QACR,OAAO,wBAAS,CAAC,MAAM;AAAA,MACzB;AAAA,IACF;AAAA,EACF,CAAC;AACH;AAEO,MAAM,wBAAwB,UAAU,yBAAyB;AACjE,MAAM,mBAAmB,UAAU,oBAAoB;AACvD,MAAM,oCAAoC;AAAA,EAC/C;AACF;AACO,MAAM,+BAA+B;AAAA,EAC1C;AACF;AAEO,MAAM,4BAA+D;AAAA,EAC1E,2BAA2B;AAAA,EAC3B,sBAAsB;AAAA,EACtB,wCAAwC;AAAA,EACxC,mCAAmC;AAAA;AAAA;AAAA;AAAA;AAAA;AAMrC;AAiBO,SAAS,uBACd,IACA,MACA,QACA,SACA;AACA,QAAM,WAAW,0BAA0B,IAAI;AAC/C,QAAM,iBAGF,CAAC;AACL,QAAM,uBAAuB,CAC3B,WAC0D;AAC1D,UAAM,mBAAkB,iCAAQ,aAAY,QAAQ;AACpD,QAAI,CAAC,eAAe,eAAe,GAAG;AAEpC,qBAAe,eAAe,QAAI;AAAA,QAIhC;AAAA,QACA,iCACK,UADL;AAAA,UAEE,UAAU;AAAA,QACZ;AAAA,QACA;AAAA,MACF;AAAA,IACF;AACA,WAAO,eAAe,eAAe;AAAA,EACvC;AAEA,SAAO,GAAG;AAAA,IACR;AAAA,MACE,MAAM,SAAS;AAAA,MACf,cAAc,SAAS;AAAA,MACvB,MAAM,SAAS;AAAA,IACjB;AAAA,IACA,CAAO,OAAOA,aAAY;AACxB,YAAM,gBAAgB,qBAAqBA,QAAO;AAClD,YAAM,WAAW,MAAM;AAAA,QACrB,MAAM,IAAI,CAAC,MAAM;AACf,iBAAO;AAAA,YACL,SAAS,EAAE;AAAA,YACX,WAAWA,YAAA,gBAAAA,SAAS;AAAA,YACpB,OAAOA,YAAA,gBAAAA,SAAS;AAAA,UAClB;AAAA,QACF,CAAC;AAAA,MACH;AACA,aAAO;AAAA,QACL,YAAY,SAAS,YAAY,IAAI,CAAC,OAAO;AAAA,UAC3C,WAAW,EAAE,WAAW;AAAA,QAC1B,EAAE;AAAA,MACJ;AAAA,IACF;AAAA,EACF;AACF;","names":["options"]}